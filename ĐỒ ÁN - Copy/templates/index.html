<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSP Solver - Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 0;
            border: 2px solid #2d6b3d;
        }

        .sidebar {
            width: 400px;
            background: #ffffff;
            border-right: 2px solid #2d6b3d;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            background: #2d6b3d;
            color: #fff;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #2d6b3d;
        }

        .sidebar-header h1 {
            font-size: 20px;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .section {
            border-bottom: 2px solid #2d6b3d;
            padding: 15px;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: #2d6b3d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .city-list {
            background: #fff;
            border: 1px solid #2d6b3d;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .city-item {
            background: #fff;
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #2d6b3d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .city-item:hover {
            background: #f0f0f0;
        }

        .city-item.highlighted {
            background: #2d6b3d;
            color: #fff;
            font-weight: bold;
        }

        .city-item.highlighted .city-coords {
            color: #ccc;
        }

        .city-name {
            font-weight: bold;
            color: #2d6b3d;
            font-size: 13px;
        }

        .city-item.highlighted .city-name {
            color: #fff;
        }

        .city-coords {
            font-size: 10px;
            color: #666;
        }

        .delete-btn {
            background: #2d6b3d;
            color: #fff;
            border: 1px solid #2d6b3d;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Courier New', monospace;
        }

        .delete-btn:hover {
            background: #fff;
            color: #2d6b3d;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: 2px solid #2d6b3d;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #2d6b3d;
            color: #fff;
        }

        .btn-primary:hover {
            background: #fff;
            color: #2d6b3d;
        }

        .btn-secondary {
            background: #fff;
            color: #2d6b3d;
        }

        .btn-secondary:hover {
            background: #2d6b3d;
            color: #fff;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .calculation-steps {
            border: 1px solid #2d6b3d;
            padding: 15px;
            background: #fff;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.6;
        }

        .step-item {
            padding: 8px 0;
            border-bottom: 1px dashed #ccc;
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-item.active {
            background: #2d6b3d;
            color: #fff;
            padding: 8px;
            margin: 0 -15px;
            padding-left: 15px;
            padding-right: 15px;
        }

        .step-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .step-candidates {
            padding-left: 15px;
            color: #666;
        }

        .step-item.active .step-candidates {
            color: #ccc;
        }

        .step-chosen {
            color: #2d6b3d;
            font-weight: bold;
            margin-top: 5px;
        }

        .step-item.active .step-chosen {
            color: #fff;
        }

        .result-box {
            background: #fff;
            border: 2px solid #2d6b3d;
            padding: 15px;
            margin-top: 0;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .result-title {
            font-size: 16px;
            font-weight: bold;
            color: #2d6b3d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .distance {
            font-size: 36px;
            font-weight: bold;
            color: #2d6b3d;
            text-align: center;
            margin: 15px 0;
            border: 2px solid #2d6b3d;
            padding: 15px;
        }

        .route-steps {
            background: #fff;
            border: 1px solid #2d6b3d;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .route-step {
            padding: 8px;
            margin-bottom: 5px;
            background: #fff;
            border: 1px solid #2d6b3d;
            font-size: 12px;
        }

        .route-step.active {
            background: #2d6b3d;
            color: #fff;
            font-weight: bold;
        }

        .map-container {
            flex: 1;
            background: #fff;
            overflow: hidden;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .status-message {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 2px solid #2d6b3d;
            padding: 10px 20px;
            z-index: 1000;
            display: none;
            font-size: 12px;
            font-weight: bold;
            color: #2d6b3d;
            text-transform: uppercase;
        }

        .status-message.show {
            display: block;
        }

        .map-instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 2px solid #2d6b3d;
            padding: 10px 20px;
            z-index: 1000;
            font-size: 12px;
            color: #2d6b3d;
        }

        .spinner {
            border: 2px solid #fff;
            border-top: 2px solid #2d6b3d;
            width: 15px;
            height: 15px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #fff;
            border-left: 1px solid #2d6b3d;
        }

        ::-webkit-scrollbar-thumb {
            background: #2d6b3d;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #333;
        }

        /* Comparison styles */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #2d6b3d;
            padding: 8px 5px;
            text-align: left;
        }

        .comparison-table th {
            background: #2d6b3d;
            color: #fff;
            font-weight: bold;
        }

        .comparison-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .comparison-best {
            background: #2d6b3d !important;
            color: #fff !important;
            font-weight: bold;
        }

        .chart-container {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #2d6b3d;
            background: #fff;
        }

        .chart-title {
            font-weight: bold;
            color: #2d6b3d;
            margin-bottom: 5px;
            font-size: 11px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 10px;
        }

        .chart-label {
            width: 120px;
            font-weight: bold;
        }

        .chart-bar-fill {
            height: 20px;
            background: #2d6b3d;
            margin-right: 5px;
            transition: width 0.3s;
        }

        .chart-value {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-route"></i> TSP Solver</h1>
                <p>Traveling Salesman Problem v·ªõi Greedy Best-First Search</p>
            </div>
            
            <div class="sidebar-content">
                <div class="section">
                    <div class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        ƒê·ªãa ƒëi·ªÉm (<span id="city-count">5</span>)
                    </div>
                    <div class="city-list" id="city-list">
                        <!-- Cities will be loaded here -->
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">
                        <i class="fas fa-cog"></i>
                        CH·ªåN THU·∫¨T TO√ÅN
                    </div>
                    <select id="algorithm-select" style="width: 100%; padding: 10px; border: 2px solid #2d6b3d; font-family: 'Courier New', monospace; font-size: 13px; margin-bottom: 10px; background: #fff;">
                        <option value="greedy">Greedy Best-First Search</option>
                        <option value="best-first">Uniform Cost Search (UCS)</option>
                        <option value="astar">A* Algorithm</option>
                    </select>
                    
                    <button class="btn btn-primary" id="solve-btn" onclick="solveTSP()">
                        [RUN] GI·∫¢I B√ÄI TO√ÅN
                    </button>
                    <button class="btn btn-primary" id="compare-btn" onclick="compareAllAlgorithms()">
                        [COMPARE] SO S√ÅNH T·∫§T C·∫¢
                    </button>
                    <button class="btn btn-secondary" onclick="resetAll()">
                        [RESET] ƒê·∫∂T L·∫†I
                    </button>
                </div>

                <div class="section" id="calculation-section" style="display: none;">
                    <div class="section-title">QU√Å TR√åNH T√çNH TO√ÅN</div>
                    <div class="calculation-steps" id="calculation-steps">
                        <!-- Calculation steps will be shown here -->
                    </div>
                </div>

                <div class="section" id="result-section" style="display: none;">
                    <div class="section-title">K·∫æT QU·∫¢ CU·ªêI C√ôNG</div>
                    <div class="distance" id="total-distance">0 km</div>
                    <div class="route-steps" id="route-steps">
                        <!-- Route steps will be shown here -->
                    </div>
                </div>

                <div class="section" id="comparison-section" style="display: none;">
                    <div class="section-title">K·∫æT QU·∫¢ SO S√ÅNH</div>
                    <div id="comparison-results" style="font-size: 11px;">
                        <!-- Comparison results will be shown here -->
                    </div>
                    <div id="comparison-charts" style="margin-top: 10px;">
                        <!-- Charts will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div class="status-message" id="status-message">ƒêang t√≠nh to√°n...</div>
            
            <div class="map-instructions">
                [INFO] Click tr√™n b·∫£n ƒë·ªì ƒë·ªÉ th√™m ƒë·ªãa ƒëi·ªÉm m·ªõi
            </div>
            
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = {};
        let routeLine = null;
        let currentStepIndex = 0;
        let animationInterval = null;

        // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
        function initMap() {
            map = L.map('map').setView([16.0, 107.0], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Click v√†o b·∫£n ƒë·ªì ƒë·ªÉ th√™m ƒë·ªãa ƒëi·ªÉm
            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(4);
                const lng = e.latlng.lng.toFixed(4);
                const cityName = prompt(`Th√™m ƒë·ªãa ƒëi·ªÉm m·ªõi t·∫°i (${lat}, ${lng})\n\nNh·∫≠p t√™n ƒë·ªãa ƒëi·ªÉm:`);
                
                if (cityName && cityName.trim()) {
                    addCity(cityName.trim(), lat, lng);
                }
            });

            // Load cities ban ƒë·∫ßu
            loadCities();
        }

        // Load danh s√°ch th√†nh ph·ªë
        async function loadCities() {
            try {
                const response = await fetch('/api/cities');
                const cities = await response.json();
                
                // Clear markers
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                markers = {};
                
                // Add markers
                cities.forEach(([name, coords]) => {
                    addMarker(name, coords[0], coords[1]);
                });
                
                // Update city list UI
                updateCityList(cities);
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Th√™m marker l√™n b·∫£n ƒë·ªì
        function addMarker(name, lat, lng, isHighlight = false) {
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background: ${isHighlight ? '#2d6b3d' : '#fff'};
                    width: 20px;
                    height: 20px;
                    border: 3px solid ${isHighlight ? '#fff' : '#2d6b3d'};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: ${isHighlight ? '#fff' : '#2d6b3d'};
                    font-weight: bold;
                    font-size: 10px;
                    font-family: 'Courier New', monospace;
                ">‚óè</div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            const marker = L.marker([lat, lng], { icon: icon })
                .bindPopup(`<div style="font-family: 'Courier New', monospace;">
                    <strong>${name}</strong><br>
                    Lat: ${lat}<br>
                    Lng: ${lng}
                </div>`)
                .addTo(map);
            
            markers[name] = marker;
            return marker;
        }

        // Update danh s√°ch th√†nh ph·ªë
        function updateCityList(cities) {
            const cityList = document.getElementById('city-list');
            const cityCount = document.getElementById('city-count');
            
            cityCount.textContent = cities.length;
            cityList.innerHTML = '';
            
            cities.forEach(([name, coords]) => {
                const div = document.createElement('div');
                div.className = 'city-item';
                div.id = `city-${name}`;
                div.innerHTML = `
                    <div>
                        <div class="city-name">${name}</div>
                        <div class="city-coords">${coords[0].toFixed(4)}, ${coords[1].toFixed(4)}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteCity('${name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                cityList.appendChild(div);
            });
        }

        // Th√™m th√†nh ph·ªë m·ªõi
        async function addCity(name, lat, lng) {
            try {
                const response = await fetch('/api/cities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, lat, lng })
                });
                
                const data = await response.json();
                if (data.success) {
                    await loadCities();
                }
            } catch (error) {
                console.error('Error adding city:', error);
                alert('L·ªói khi th√™m ƒë·ªãa ƒëi·ªÉm!');
            }
        }

        // X√≥a th√†nh ph·ªë
        async function deleteCity(name) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a "${name}"?`)) return;
            
            try {
                const response = await fetch(`/api/cities/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.success) {
                    await loadCities();
                    // Clear result
                    document.getElementById('result-box').classList.remove('show');
                }
            } catch (error) {
                console.error('Error deleting city:', error);
                alert('L·ªói khi x√≥a ƒë·ªãa ƒëi·ªÉm!');
            }
        }

        // Gi·∫£i b√†i to√°n TSP
        async function solveTSP() {
            const solveBtn = document.getElementById('solve-btn');
            const statusMessage = document.getElementById('status-message');
            const algorithm = document.getElementById('algorithm-select').value;
            
            // Disable button
            solveBtn.disabled = true;
            solveBtn.innerHTML = '[PROCESSING...]';
            
            // Show status
            statusMessage.textContent = 'üîç ƒêang t√≠nh to√°n ma tr·∫≠n kho·∫£ng c√°ch...';
            statusMessage.classList.add('show');
            
            // Hide old results
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('calculation-section').style.display = 'none';
            document.getElementById('comparison-section').style.display = 'none';
            
            // Clear all old layers (lines and labels)
            map.eachLayer(function(layer) {
                if (layer instanceof L.Polyline || (layer instanceof L.Marker && layer.options.icon && layer.options.icon.options.className === 'distance-label')) {
                    map.removeLayer(layer);
                }
            });
            
            try {
                // Start solving
                const response = await fetch('/api/solve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ algorithm: algorithm })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update status
                    statusMessage.textContent = '‚úÖ Ho√†n th√†nh! ƒêang v·∫Ω animation...';
                    
                    // Show results with animation
                    await animateSolution(data);
                    
                    // Display final result
                    displayResult(data);
                    
                    // Hide status after animation
                    statusMessage.classList.remove('show');
                } else {
                    alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
                }
            } catch (error) {
                console.error('Error solving TSP:', error);
                alert('L·ªói khi gi·∫£i b√†i to√°n!');
            } finally {
                // Re-enable button
                solveBtn.disabled = false;
                solveBtn.innerHTML = '[RUN] GI·∫¢I B√ÄI TO√ÅN';
                statusMessage.classList.remove('show');
            }
        }

        // Animate gi·∫£i ph√°p t·ª´ng b∆∞·ªõc
        async function animateSolution(data) {
            const steps = data.steps;
            const calculationSteps = document.getElementById('calculation-steps');
            const calculationSection = document.getElementById('calculation-section');
            
            calculationSection.style.display = 'block';
            calculationSteps.innerHTML = '';
            
            // Get city coordinates
            const response = await fetch('/api/cities');
            const cities = await response.json();
            const cityMap = Object.fromEntries(cities);
            
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                
                // Highlight current city in sidebar
                document.querySelectorAll('.city-item').forEach(item => {
                    item.classList.remove('highlighted');
                });
                
                if (step.current) {
                    const currentCityElem = document.getElementById(`city-${step.current}`);
                    if (currentCityElem) {
                        currentCityElem.classList.add('highlighted');
                        currentCityElem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
                
                // Add calculation step to sidebar
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step-item active';
                stepDiv.id = `calc-step-${i}`;
                
                let stepHTML = `<div class="step-header">B∆Ø·ªöC ${step.step}: ${step.current || 'B·∫Øt ƒë·∫ßu'}</div>`;
                
                if (step.candidates && step.candidates.length > 0) {
                    const algorithm = document.getElementById('algorithm-select').value;
                    const algName = algorithm === 'greedy' ? 'Greedy BFS' : (algorithm === 'best-first' ? 'UCS' : 'A*');
                    stepHTML += `<div class="step-candidates">ƒê√°nh gi√° (${algName}):<br>`;
                    step.candidates.forEach(c => {
                        const heuristic = c.heuristic !== undefined ? c.heuristic : 'N/A';
                        const g = c.g !== undefined ? c.g : c.distance;
                        const f = c.f !== undefined ? c.f : 'N/A';
                        stepHTML += `  ‚Ä¢ ${c.city}:<br>`;
                        if (algorithm === 'greedy') {
                            stepHTML += `    - h(n) = ${heuristic.toFixed(2)} km ‚≠ê<br>`;
                        } else if (algorithm === 'best-first') {
                            stepHTML += `    - g(n) = ${g.toFixed(2)} km ‚≠ê<br>`;
                        } else {
                            stepHTML += `    - g(n) = ${g.toFixed(2)} km<br>`;
                            stepHTML += `    - h(n) = ${heuristic.toFixed(2)} km<br>`;
                            stepHTML += `    - f(n) = ${f.toFixed(2)} km ‚≠ê<br>`;
                        }
                    });
                    stepHTML += '</div>';
                    
                    if (step.next) {
                        const hInfo = step.heuristic !== undefined ? ` (h=${step.heuristic.toFixed(2)} km - nh·ªè nh·∫•t)` : '';
                        stepHTML += `<div class="step-chosen">‚Üí CH·ªåN: ${step.next}${hInfo}<br>Chi ph√≠: ${step.distance.toFixed(2)} km</div>`;
                    }
                } else if (step.next) {
                    stepHTML += `<div class="step-chosen">‚Üí Quay v·ªÅ: ${step.next} (${step.distance.toFixed(2)} km)</div>`;
                }
                
                stepDiv.innerHTML = stepHTML;
                calculationSteps.appendChild(stepDiv);
                
                // Scroll to latest step
                stepDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
                
                // Highlight marker on map
                await loadCities();
                if (step.current_idx !== undefined && data.route[step.step] !== undefined) {
                    const cityName = data.route[step.step];
                    const city = cities.find(c => c[0] === cityName);
                    
                    if (city) {
                        if (markers[cityName]) {
                            map.removeLayer(markers[cityName]);
                        }
                        addMarker(cityName, city[1][0], city[1][1], true);
                    }
                }
                
                // Draw line from current to next
                if (step.next && step.current) {
                    const currentCoords = cityMap[step.current];
                    const nextCoords = cityMap[step.next];
                    
                    if (currentCoords && nextCoords) {
                        // Draw the new segment
                        const newLine = L.polyline([
                            [currentCoords[0], currentCoords[1]],
                            [nextCoords[0], nextCoords[1]]
                        ], {
                            color: '#2d6b3d',
                            weight: 3,
                            opacity: 0.8
                        }).addTo(map);
                        
                        // Add label for distance
                        const midLat = (currentCoords[0] + nextCoords[0]) / 2;
                        const midLng = (currentCoords[1] + nextCoords[1]) / 2;
                        
                        L.marker([midLat, midLng], {
                            icon: L.divIcon({
                                className: 'distance-label',
                                html: `<div style="
                                    background: #2d6b3d;
                                    color: #fff;
                                    padding: 3px 8px;
                                    font-size: 11px;
                                    font-weight: bold;
                                    border: 1px solid #2d6b3d;
                                    white-space: nowrap;
                                ">${step.distance.toFixed(1)} km</div>`,
                                iconSize: [60, 20]
                            })
                        }).addTo(map);
                    }
                }
                
                // Remove active class from previous step
                if (i > 0) {
                    const prevStep = document.getElementById(`calc-step-${i-1}`);
                    if (prevStep) {
                        prevStep.classList.remove('active');
                    }
                }
                
                // Wait for animation
                await new Promise(resolve => setTimeout(resolve, 1200));
            }
            
            // Remove active class from last step
            const lastStep = document.getElementById(`calc-step-${steps.length-1}`);
            if (lastStep) {
                lastStep.classList.remove('active');
            }
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ cu·ªëi c√πng
        async function displayResult(data) {
            const resultSection = document.getElementById('result-section');
            const totalDistance = document.getElementById('total-distance');
            const routeSteps = document.getElementById('route-steps');
            
            // Show result section
            resultSection.style.display = 'block';
            
            // Display distance
            totalDistance.textContent = `${data.total_distance.toFixed(2)} km`;
            
            // Display route
            routeSteps.innerHTML = '';
            data.route.forEach((city, index) => {
                const div = document.createElement('div');
                div.className = 'route-step';
                div.innerHTML = `[${index + 1}] ${city}`;
                routeSteps.appendChild(div);
            });
            
            // Fit map to route
            const response = await fetch('/api/cities');
            const cities = await response.json();
            const cityMap = Object.fromEntries(cities);
            
            const routeCoords = data.route.map(cityName => {
                const coords = cityMap[cityName];
                return [coords[0], coords[1]];
            });
            
            map.fitBounds(L.latLngBounds(routeCoords), { padding: [50, 50] });
        }

        // Reset t·∫•t c·∫£
        async function resetAll() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·∫∑t l·∫°i t·∫•t c·∫£?')) return;
            
            try {
                const response = await fetch('/api/reset', {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    // Clear all layers except base map
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                            map.removeLayer(layer);
                        }
                    });
                    
                    routeLine = null;
                    
                    // Hide result sections
                    document.getElementById('result-section').style.display = 'none';
                    document.getElementById('calculation-section').style.display = 'none';
                    
                    // Reload cities
                    await loadCities();
                }
            } catch (error) {
                console.error('Error resetting:', error);
                alert('L·ªói khi ƒë·∫∑t l·∫°i!');
            }
        }

        // So s√°nh t·∫•t c·∫£ thu·∫≠t to√°n
        async function compareAllAlgorithms() {
            const compareBtn = document.getElementById('compare-btn');
            const statusMessage = document.getElementById('status-message');
            
            // Disable button
            compareBtn.disabled = true;
            compareBtn.innerHTML = '[COMPARING...]';
            
            // Show status
            statusMessage.textContent = 'üìä ƒêang ch·∫°y t·∫•t c·∫£ thu·∫≠t to√°n...';
            statusMessage.classList.add('show');
            
            // Hide other sections
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('calculation-section').style.display = 'none';
            
            try {
                const response = await fetch('/api/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayComparison(data.results);
                    document.getElementById('comparison-section').style.display = 'block';
                    statusMessage.classList.remove('show');
                } else {
                    alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
                }
            } catch (error) {
                console.error('Error comparing algorithms:', error);
                alert('L·ªói khi so s√°nh thu·∫≠t to√°n!');
            } finally {
                compareBtn.disabled = false;
                compareBtn.innerHTML = '[COMPARE] SO S√ÅNH T·∫§T C·∫¢';
                statusMessage.classList.remove('show');
            }
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ so s√°nh
        function displayComparison(results) {
            const resultsDiv = document.getElementById('comparison-results');
            const chartsDiv = document.getElementById('comparison-charts');
            
            // T·∫°o b·∫£ng so s√°nh
            let html = '<table class="comparison-table"><thead><tr>';
            html += '<th>Thu·∫≠t to√°n</th><th>Kho·∫£ng c√°ch (km)</th><th>Th·ªùi gian</th><th>Nodes</th><th>Operations</th>';
            html += '</tr></thead><tbody>';
            
            // T√¨m gi√° tr·ªã t·ªët nh·∫•t
            let bestDistance = Infinity;
            let bestTime = Infinity;
            let bestNodes = Infinity;
            let bestOps = Infinity;
            
            Object.values(results).forEach(r => {
                if (r.distance < bestDistance) bestDistance = r.distance;
                if (r.time < bestTime) bestTime = r.time;
                if (r.nodes < bestNodes) bestNodes = r.nodes;
                if (r.operations < bestOps) bestOps = r.operations;
            });
            
            Object.keys(results).forEach(algo => {
                const r = results[algo];
                const distClass = r.distance === bestDistance ? ' comparison-best' : '';
                const timeClass = r.time === bestTime ? ' comparison-best' : '';
                const nodesClass = r.nodes === bestNodes ? ' comparison-best' : '';
                const opsClass = r.operations === bestOps ? ' comparison-best' : '';
                
                // Format time v·ªõi ƒë∆°n v·ªã ph√π h·ª£p
                const timeDisplay = r.time_display || `${r.time.toFixed(4)}s`;
                
                html += `<tr>
                    <td><strong>${algo}</strong></td>
                    <td class="${distClass}">${r.distance}</td>
                    <td class="${timeClass}">${timeDisplay}</td>
                    <td class="${nodesClass}">${r.nodes}</td>
                    <td class="${opsClass}">${r.operations}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
            
            // T·∫°o bi·ªÉu ƒë·ªì
            chartsDiv.innerHTML = '';
            
            // Bi·ªÉu ƒë·ªì kho·∫£ng c√°ch
            const distanceChart = createBarChart('Kho·∫£ng c√°ch (km)', results, 'distance', bestDistance);
            chartsDiv.appendChild(distanceChart);
            
            // Bi·ªÉu ƒë·ªì th·ªùi gian
            const timeChart = createBarChart('Th·ªùi gian (s)', results, 'time', bestTime);
            chartsDiv.appendChild(timeChart);
            
            // Bi·ªÉu ƒë·ªì nodes
            const nodesChart = createBarChart('S·ªë nodes ƒë√£ x√©t', results, 'nodes', bestNodes);
            chartsDiv.appendChild(nodesChart);
            
            // Bi·ªÉu ƒë·ªì operations
            const opsChart = createBarChart('S·ªë operations', results, 'operations', bestOps);
            chartsDiv.appendChild(opsChart);
        }

        // T·∫°o bi·ªÉu ƒë·ªì thanh
        function createBarChart(title, results, key, bestValue) {
            const container = document.createElement('div');
            container.className = 'chart-container';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'chart-title';
            titleDiv.textContent = title;
            container.appendChild(titleDiv);
            
            // T√¨m gi√° tr·ªã max ƒë·ªÉ scale
            let maxValue = 0;
            Object.values(results).forEach(r => {
                if (r[key] > maxValue) maxValue = r[key];
            });
            
            Object.keys(results).forEach(algo => {
                const value = results[algo][key];
                const percentage = (value / maxValue) * 100;
                
                const barDiv = document.createElement('div');
                barDiv.className = 'chart-bar';
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'chart-label';
                labelDiv.textContent = algo.replace(' Search', '').replace(' Algorithm', '');
                
                const fillDiv = document.createElement('div');
                fillDiv.className = 'chart-bar-fill';
                fillDiv.style.width = `${percentage}%`;
                if (value === bestValue) {
                    fillDiv.style.background = '#2d6b3d';
                } else {
                    fillDiv.style.background = '#999';
                }
                
                const valueDiv = document.createElement('div');
                valueDiv.className = 'chart-value';
                valueDiv.textContent = value;
                
                barDiv.appendChild(labelDiv);
                barDiv.appendChild(fillDiv);
                barDiv.appendChild(valueDiv);
                
                container.appendChild(barDiv);
            });
            
            return container;
        }

        // Initialize when page loads
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html>
